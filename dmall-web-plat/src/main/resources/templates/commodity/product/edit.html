<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>
        商品详情
    </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" href="./css/admin.css" media="all">
    <link rel="stylesheet" th:href="@{/layui/css/formSelects-v4.css}" href="./css/admin.css" media="all">
    <style>
        .size{
            font-size: 20px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品信息维护</legend>
    </fieldset>
    <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this">基本信息</li>
            <li>扩展信息</li>
            <li>图片信息</li>
        </ul>
        <div class="layui-tab-content" style="height: 100px;">
            <button  id="saveProduct" type="button"  class="layui-btn" style="float: right">保存</button>
            <div class="layui-tab-item layui-show">
                <form class="layui-form" id="product-form" action="">
                    <div class="layui-row" th:if="${productVo.product.id!=null}" >
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">商品编码</label>
                            <div class="layui-input-inline">
                                <input type="text" name="productCode" lay-verify="required" autocomplete="off"
                                       class="layui-input" readonly >
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">最高价</label>
                            <div class="layui-input-inline">
                                <input type="text" name="maxPrice"  autocomplete="off"
                                       class="layui-input" disabled="disabled" >
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">最低价</label>
                            <div class="layui-input-inline">
                                <input type="text" name="minPrice"  autocomplete="off"
                                       class="layui-input" disabled="disabled" >
                            </div>
                        </div>
                    </div>
                    <div class="layui-row" style="margin-top: 10px">
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">商品名称</label>
                            <div class="layui-input-block">
                                <input type="hidden" name="id" />
                                <input type="text" name="name" lay-verify="required" class="layui-input">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4" th:if="${productVo.product.id!=null}">
                            <label class="layui-form-label">销量</label>
                            <div class="layui-input-block">
                                <input type="text" name="saleCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4" th:if="${productVo.product.id!=null}">
                            <label class="layui-form-label">浏览量</label>
                            <div class="layui-input-block">
                                <input type="text" name="viewCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                    </div>
                    <div class="layui-row" style="margin-top: 10px" >
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md8 layui-col-lg8">
                            <label class="layui-form-label">商品副名称</label>
                            <div class="layui-input-block">
                                <input type="text" name="subName" lay-verify="required" class="layui-input">
                            </div>
                        </div>

                    </div>
                    <div class="layui-row" style="margin-top: 10px" th:if="${productVo.product.id!=null}" >
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">评论数</label>
                            <div class="layui-input-block">
                                <input type="text" name="commentCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">评分</label>
                            <div class="layui-input-block">
                                <input type="text" name="commentScore" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">好评率</label>
                            <div class="layui-input-block">
                                <input type="text" name="goodRate" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                    </div>
                    <div class="layui-row" style="margin-top: 10px" th:if="${productVo.product.id!=null}" >
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">好评数</label>
                            <div class="layui-input-block">
                                <input type="text" name="goodCommentCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">中评数</label>
                            <div class="layui-input-block">
                                <input type="text" name="middleCommentCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">
                            <label class="layui-form-label">差评数</label>
                            <div class="layui-input-block">
                                <input type="text" name="badCommentCount" class="layui-input" disabled="disabled">
                            </div>
                        </div>
                    </div>
                    <div class="layui-row" style="margin-top: 10px">
                        <label class="layui-form-label">商品简介</label>
                        <div class="layui-input-block">
                            <textarea name="description" lay-verify="required"  placeholder="请输入内容" class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-row" style="margin-top: 10px">
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md3 layui-col-lg3">
                            <label class="layui-form-label">上市时间</label>
                            <div class="layui-input-inline">
                                <input type="text" id="onCityTime" class="layui-input date"  name="onCityTime" placeholder="yyyy-MM-dd">
                            </div>
                        </div>
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md3 layui-col-lg3">
                            <label class="layui-form-label">是否有效</label>
                            <div class="layui-input-inline">
                                <select loadData="normal" lay-verify="required" name="status"  dict="_status" value="1">
                                </select>
                            </div>
                        </div>                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 layui-col-lg6">
                            <label class="layui-form-label">商品分类</label>
                            <div class="layui-input-block">
                                <select loadData="linkage" url="/type/tree" xm-select-search=""
                                        id="productType" name="productType" xm-select="productType"
                                        linkage="true" linkageWidth="140" xm-select-radio="" lay-verify="required"   >
                                </select>
                            </div>
                        </div>

                    </div>
                    <div class="layui-row" style="margin-top: 10px">
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md6 layui-col-lg6">
                            <label class="layui-form-label">品牌</label>
                            <div class="layui-input-block">
                                <select id="brandId" name="brandId" lay-filter="brandId" lay-verify="required"  loadData="normal" url="/brand/listAll"  >
                                </select>
                            </div>
                        </div>
                        <div  class=" layui-col-xs6 layui-col-sm6 layui-col-md6 layui-col-lg6">
                            <div class="layui-input-block">
                                <button type="button" class="layui-btn" id="addProps"><i class="layui-icon layui-icon-add-circle-fine"></i>添加属性组</button>
                            </div>
                        </div>
                        <button type="button" class="layui-btn" lay-submit="" style="display: none" id="submit"  lay-filter="submit">立即提交</button>
                    </div>
                    <!--<div  style="text-align: center;height: 100px;background-color: #eee; color: #666; font-weight: 300;padding-bottom: 0px;line-height: 100px;width: 100%">
                        <p>
                            地猫商城后台管理系统 版权所有 仿冒必究
                        </p>
                    </div>-->
                </form>
            </div>
            <div class="layui-tab-item">
                <form class="layui-form" id="ext-form" action="">
                    <h3>图文详情</h3>
                    <input type="hidden" name="productCode">
                    <input type="hidden" name="id">
                    <textarea id="richContent" name="richContent" th:if="${productVo!=null}" th:text="${productVo.productExt.richContent}"></textarea>
                </form>
            </div>
            <div class="layui-tab-item">
                <fieldset class="layui-elem-field">
                    <legend>添加商品图片</legend>
                    <div class="layui-field-box">
                        <div class="layui-upload">
                            <h4>默认第一张为商品主图</h4>
                            <hr class="layui-bg-green">
                            <button type="button" class="layui-btn" id="up">多图片上传</button>
                            <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                                预览图：
                                <div id="layer-photos-demo" class="layer-photos-demo">
                                    <img src="http://pgdyorkvy.bkt.clouddn.com/ea1e5a77d8494b8c9fb3d517642269d9.jpg?v=1539355305343&amp;imageView2/2/w/160/h/160" layer-src="http://pgdyorkvy.bkt.clouddn.com/ea1e5a77d8494b8c9fb3d517642269d9.jpg?v=1539355305343" alt="示例图片">
                                    <span th:if="${productVo.product.id!=null}" th:each="imgObj : ${productVo.imgUrls}">
                                        <img  th:src="${imgObj.imgSrc}" th:key="${imgObj.imgKey}" th:layer-src="${imgObj.layerSrc}" alt="商品图片" >
                                        <i class="layui-icon layui-icon-close-fill"  style="color:red;cursor:pointer;" th:imgSrc="${imgObj.imgKey}" ></i>
                                    </span>

                                </div>
                            </blockquote>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    <script th:src="@{/layui/layui.js}" src="./lib/layui/layui.js" charset="utf-8"></script>
    <script th:inline="javascript">
        layui.config({
            base: '/controller/'
        }).use(['element','form', 'transfer','curd','layer','layedit','upload','croppers'], function () {
            var $=layui.$;
            var form = layui.form;
            var transfer = layui.transfer;
            var curd=layui.curd;
            var element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
            var formSelects = layui.formSelects;
            var upload = layui.upload;
            var layer= layui.layer;
            var croppers = layui.croppers;
            var i=0;
            var productVo=[[${productVo}]];
            var layedit = layui.layedit;
            // 建立编辑器
            layedit.set({
                uploadImage: {
                    url: '/product/layEditUpload' //接口url
                }
            });
            var extIndex=layedit.build('richContent',{
                height: 1000 //设置编辑器高度
            });

            // 初始化表单内容
            transfer.init([[${productVo.product}]],null,'product-form');
            transfer.init([[${productVo.productExt}]],null,'ext-form');
            transfer.initDate('product-form','yyyy-MM-dd');

            // 商品分类选择事件
            formSelects.on('productType', function(id, vals, val, isAdd, isDisabled){
                //id:           点击select的id
                //vals:         当前select已选中的值
                //val:          当前select点击的值
                //isAdd:        当前操作选中or取消
                //isDisabled:   当前选项是否是disabled
                var split=val.value.split("/");
                $("#brandId").attr("url","/brand/listAll?productTypeId="+split[split.length-1]);
                transfer.initSelect('brandId');
                $("#addProps").parents(".layui-row").nextAll(".layui-row").remove();
                i=0;
            });
            // 编辑时初始化数据
            if(productVo.product.id){
                var product=productVo.product;
                var split=product.productType.split("/");
                $("#brandId").attr("url","/brand/listAll?productTypeId="+split[split.length-1]);
                $("#brandId").val(product.brandId);
                transfer.initSelect('brandId');
                var propsVoList=productVo.propsVoList;
                var k=0;
                for(;k<propsVoList.length;k++){
                    var propsVo=propsVoList[k];
                    var productTypeId=propsVo.productType;
                    var group=propsVo.id;
                    var propsList= propsVo.propsList;
                    var props=''
                    for(var j=0;j<propsList.length;j++){
                        props+=propsList[j].id+',';
                    }
                    props=props.substring(0,props.length-1);
                    var isSale=propsVo.isSale;
                    var html='';
                    if(isSale==1){
                        html='<div class="layui-row" style="margin-top: 10px">'
                            +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">属性组</label> <div class="layui-input-block">'
                            + '<select loadData="normal" lay-filter="group" id='+k+' url="/props/group/listAll?productTypeId='+productTypeId+'">'
                            +' </select></div></div>'
                            +'<div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">属性</label> <div class="layui-input-block">'
                            + '<select loadData="normal" value="'+props+'" xm-select-search="" id="props'+k+'" xm-select="props'+k+'" url="/props/listAll?productTypeId='+productTypeId+'">'
                            +' </select></div></div>'
                            +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">销售属性</label><div class="layui-input-block">'
                            + '<input type="checkbox"  id="sale'+k+'" checked lay-skin="switch" lay-text="是|否">&nbsp;&nbsp;'
                            + '<i class="layui-icon layui-icon-delete size" id="delete'+k+'" ></i>'
                            +'</div></div>'
                            + '</div>';
                    }else {
                        html='<div class="layui-row" style="margin-top: 10px">'
                            +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">属性组</label> <div class="layui-input-block">'
                            + '<select loadData="normal" value="'+group+'"  lay-filter="group" id='+k+' url="/props/group/listAll?productTypeId='+productTypeId+'">'
                            +' </select></div></div>'
                            +'<div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">属性</label> <div class="layui-input-block">'
                            + '<select loadData="normal" value="'+props+'" xm-select-search="" id="props'+k+'" xm-select="props'+k+'" url="/props/listAll?productTypeId='+productTypeId+'&groupId='+group+'">'
                            +' </select></div></div>'
                            +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                            +'<label class="layui-form-label">销售属性</label><div class="layui-input-block">'
                            + '<input type="checkbox" id="sale'+k+'" lay-skin="switch" lay-text="是|否">&nbsp;&nbsp;'
                            + '<i class="layui-icon layui-icon-delete size" id="delete'+k+'" ></i>'
                            +'</div></div>'
                            + '</div>';
                    }
                    $("#addProps").parents(".layui-row").after(html);
                    transfer.initSelect(k+'');
                    transfer.initSelect('props'+k);
                }
                i=k;
            }

            // 添加属性组点击事件
            $("#addProps").click(function () {
                var productType=formSelects.value('productType');
                var productTypeId='';
                if(productType && productType[0]){
                    productTypeId=productType[0].value;
                }
                var html='<div class="layui-row" style="margin-top: 10px">'
                    +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                    +'<label class="layui-form-label">属性组</label> <div class="layui-input-block">'
                    + '<select loadData="normal"  lay-filter="group" id='+i+' url="/props/group/listAll?productTypeId='+productTypeId+'">'
                    +' </select></div></div>'
                    +'<div  class=" layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                    +'<label class="layui-form-label">属性</label> <div class="layui-input-block">'
                    + '<select loadData="normal" xm-select-search="" id="props'+i+'" xm-select="props'+i+'" url="/props/listAll?productTypeId='+productTypeId+'">'
                    +' </select></div></div>'
                    +'<div  class="layui-col-xs6 layui-col-sm6 layui-col-md4 layui-col-lg4">'
                    +'<label class="layui-form-label">销售属性</label><div class="layui-input-block">'
                    + '<input type="checkbox" id="sale'+i+'"  lay-skin="switch" lay-text="是|否">&nbsp;&nbsp;'
                    + '<i class="layui-icon layui-icon-delete size" id="delete'+i+'" ></i>'
                    +'</div></div>'
                    + '</div>'
                $(this).parents(".layui-row").after(html);
                transfer.initSelect(i+'');
                transfer.initSelect('props'+i);
                i++;
            });

            // 监听属性组
            form.on('select(group)',function (data) {
                var productType=formSelects.value('productType');
                var productTypeId='';
                if(productType && productType[0]){
                    productTypeId=productType[0].value;
                }
                var id=$(data.elem).attr("id");
                $("#props"+id).attr("url","/props/listAll?productTypeId="+productTypeId+"&groupId="+data.value);
                transfer.initSelect('props'+id);
            })

            // 删除属性组
            $(document).on('click','.layui-icon-delete',function () {
                var sel=$(this);
                layer.confirm('确定删除该属性组以及属性?', {icon: 3, title:'提示'}, function(index){
                    layer.close(index);
                    sel.parents(".layui-row").remove();
                });
            })

            // 保存按钮点击事件
            $("#saveProduct").click(function () {
               $("#submit").click();
                var product=curd.toJson('product-form');
                layedit.sync(extIndex);
                var ext=curd.toJson('ext-form');
                var productDTO={};
                productDTO.product=product;
                productDTO.productExt=ext;
                var flag=0;
                var propsVoList=[];
                for(var o=0;o<i;o++){
                    var propsVo={}
                    var groupId=$("#"+o).val();
                    if(groupId==undefined){
                        continue;
                    }
                    if(groupId){
                        propsVo.id=groupId;
                    }

                    var props=formSelects.value('props'+o);
                    if(props){
                        var propsList=[];
                        for(var d=0;d<props.length;d++){
                            var propObj={};
                            var propId=props[d].value;
                            if(propId){
                                propObj.id=propId;
                            }
                            propsList.push(propObj);
                        }
                        propsVo.propsList=propsList;
                    }
                    var isSale=$("#sale"+o).is(":checked");
                    if(isSale){
                        propsVo.isSale=1;
                        flag++;
                    }else{
                        propsVo.isSale=0;

                        if(!groupId){
                            layer.msg("非销售属性必须添加属性组",{icon:2});
                            return false;
                        }
                    }
                    propsVoList.push(propsVo);
                }
                if(flag>1){
                    layer.msg("只可增加一个销售属性",{icon:2});
                    return false;
                }
                productDTO.propsVoList=propsVoList;
                var imgVoArray=[];
                $("#layer-photos-demo").find("img").each(function (index) {
                    if(index!=0){
                        //var imgVo={};
                        imgVoArray.push($(this).attr("key"));
                        //imgVo.key=;
                    }
                });
                productDTO.imgVoArray=imgVoArray;
                curd.saveOrUpdate('/product/save',productDTO,'POST',true);
            })

            //文件上传
            croppers.render({
                elem: '#up'
                ,saveW:420     //保存宽度
                ,saveH:420
                ,resizable:false
                ,mark:1/1    //选取比例
                ,area:'900px'  //弹窗宽度
                ,url: "/product/upload?productCode="+ $("input[name='productCode']").val() //图片上传接口返回和（layui 的upload 模块）返回的JOSN一样
                ,done: function(res){ //上传完毕回调
                    $("#layer-photos-demo").append('<img src="'+ res.data.src +'" key="'+ res.data.key +'" layer-src="'+ res.data.layerSrc +'" class=".delete" alt="商品图片" >' +
                        '<i class="layui-icon layui-icon-close-fill"  style="color:red;cursor:pointer;" imgSrc="'+ res.data.key +'"></i>')
                }
            });

            // 商品图片弹出层展示
            layer.photos({
                photos: '#layer-photos-demo'
                ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
            });

            // 文件删除
            $(document).on('click','.layui-icon-close-fill',function () {
                var _this=$(this);
                var layerSrc=_this.attr("imgSrc");
                layer.confirm("确认删除该照片吗?",function (ok) {
                    $.ajax({
                        url:"/product/deleteFile?key="+layerSrc,
                        type:'get',
                        beforeSend:function(){
                            layer.load(1);
                        },
                        success:function (data) {
                            if (data.code==0) {
                                _this.prev().remove();
                                _this.remove();
                                layer.msg(data.msg,{ icon: 1,time:1000 });
                            } else {
                                layer.msg(data.msg, { icon: 2,time:1000 });
                            }
                        },
                        error:function (data) {
                            if(data && data.msg){
                                layer.msg(data.msg, { icon: 2,time:1000 });
                            }else{
                                layer.msg('删除失败 未知异常', { icon: 2,time:1000 });
                            }
                        },
                        complete:function () {
                            layer.closeAll('loading');
                        }
                    })

                })
            });

            $(document).on('mouseenter','#saveProduct',function () {
                $(this).attr('style','cursor:pointer;float: right');
            })

            $(document).on('mouseenter','.layui-icon-delete',function () {
                $(this).attr('style','color:red;cursor:pointer');
            })

            $(document).on('mouseout','.layui-icon-delete',function () {
                $(this).removeAttr('style');
            })

            $(document).on('mouseenter','img',function () {
                $(this).attr('style','cursor:pointer;');
            })
        });
</script>
</body>
</html>